# 伊林SPA按摩預約系統

![License](https://img.shields.io/badge/license-MIT-blue.svg)
![Version](https://img.shields.io/badge/version-2.0.2-green.svg)
![Last Updated](https://img.shields.io/badge/last%20updated-2025--03--06-orange.svg)

伊林SPA預約系統是一個專為SPA和按摩服務設計的全功能預約管理平台。本系統協助店家管理按摩師資源、服務項目和客戶預約，提供簡潔直觀的用戶界面，優化預約流程並提升客戶體驗。

> 此版本已從特定Git提交(db4b7d8e388e20d7c4b5171bd377f1eb97a72077)恢復。上次更新時間：`2025-03-06`

## 📋 目錄

- [專案概述](#專案概述)
- [系統架構](#系統架構)
- [核心文件架構](#核心文件架構)
- [平台遷移](#平台遷移)
- [功能特色](#功能特色)
- [多價格服務功能詳細說明](#多價格服務功能詳細說明)
- [複雜服務類型功能詳解](#複雜服務類型功能詳解)
- [開發進度](#開發進度)
- [開發計劃與路線圖](#開發計劃與路線圖)
- [整合計劃：多價格服務與預約排班系統](#整合計劃多價格服務與預約排班系統)
- [系統維護工具與API](#系統維護工具與api)
- [管理員指南](#管理員指南)
- [已知問題與修復方法](#已知問題與修復方法)
- [Vercel部署指南](#vercel部署指南)
- [開發者文件](#開發者文件)
- [問題回報](#問題回報)
- [授權資訊](#授權資訊)
- [服務項目升級計劃](#服務項目升級計劃)

## 📊 專案概述

**伊林SPA預約系統**是一個專為按摩SPA設計的全功能預約管理平台，提供多價格服務選項、員工排班管理、客戶預約及會員管理功能。

- **前端框架**: Next.js 14 (App Router)
- **UI框架**: Tailwind CSS 3.4 + Radix UI
- **資料庫**: PostgreSQL 15.0 (Neon) / SQLite (本地開發)
- **ORM**: Prisma 6.2
- **認證**: NextAuth.js 4.24
- **API**: RESTful API
- **部署**: Vercel + Neon PostgreSQL
- **開發語言**: TypeScript 5.0

> **重要說明**: 本地開發環境(localhost)與生產環境(Vercel)使用不同的數據庫。在本地新增的數據（如按摩師、服務項目）不會自動同步到生產環境。請在正式環境中進行服務項目功能測試以確保數據一致性。當前服務項目功能正在優化中（測試中）。

## 🔧 系統架構

```
伊林SPA預約系統
├── 前端 (Next.js + Tailwind CSS)
│   ├── 使用者介面 (src/app/*)
│   ├── 表單驗證 (React Hook Form + Zod)
│   └── 狀態管理 (React Context)
├── 後端 (Next.js API Routes)
│   ├── RESTful API (src/app/api/*)
│   ├── 認證系統 (NextAuth - src/lib/auth/*)
│   └── 檔案上傳處理 (src/app/api/upload)
└── 資料庫 (PostgreSQL + Prisma)
    ├── 使用者數據 (src/lib/db/prisma.ts)
    ├── 預約資訊 (prisma/schema.prisma)
    └── 業務數據 (prisma/migrations/*)
```

## 📂 核心文件架構

```
src/
├── app/                            # Next.js 14 App Router 結構
│   ├── (auth)/                     # 認證相關頁面
│   │   ├── login/                  # 登入頁面
│   │   └── register/               # 註冊頁面
│   ├── (dashboard)/                # 管理介面 (需要登入)
│   │   ├── dashboard/              # 主儀表板
│   │   ├── masseurs/               # 按摩師管理頁面
│   │   │   ├── page.tsx            # 按摩師列表頁面
│   │   │   └── edit/[id]/          # 按摩師編輯/新增頁面
│   │   ├── services/               # 服務管理頁面 
│   │   ├── users/                  # 用戶管理頁面
│   │   └── layout.tsx              # 儀表板共用佈局
│   ├── admin/                      # 系統管理功能
│   │   └── repair/                 # 系統修復工具頁面
│   ├── (site)/                     # 公開網站部分
│   │   ├── masseurs/               # 公開按摩師列表
│   │   └── services/               # 公開服務列表
│   ├── api/                        # API 端點
│   │   ├── admin/                  # 管理相關API
│   │   │   ├── init-accounts/      # 初始化帳戶API
│   │   │   └── repair-accounts/    # 修復帳戶API
│   │   ├── auth/                   # 認證相關 API
│   │   ├── masseurs/               # 按摩師 API
│   │   ├── services/               # 服務 API
│   │   ├── upload/                 # 檔案上傳 API
│   │   └── users/                  # 用戶管理 API
│   └── page.tsx                    # 網站首頁
├── components/                     # 可復用組件
│   ├── admin/                      # 管理介面組件
│   │   └── user-role-management.tsx # 用戶角色管理組件
│   ├── auth/                       # 認證相關組件
│   ├── masseurs/                   # 按摩師相關組件
│   │   └── masseur-form.tsx        # 按摩師表單組件
│   ├── services/                   # 服務相關組件
│   └── ui/                         # UI基礎組件
├── lib/                            # 工具函數和庫
│   ├── auth/                       # 認證相關工具
│   │   └── auth.server.ts          # 認證配置與密碼處理
│   └── db/                         # 數據庫相關
│       └── prisma.ts               # Prisma客戶端實例
└── middleware.ts                   # Next.js中間件 (路由保護)
```

## 🔄 平台遷移

### 從Cloudflare到Vercel的遷移

#### 遷移原因

系統最初部署在Cloudflare Pages上，但由於以下限制，我們遷移至Vercel:

1. **Edge Runtime限制**: Cloudflare的Edge Runtime環境對Prisma ORM支援有限
2. **環境變數處理**: Cloudflare對敏感環境變數的處理較為複雜
3. **構建文件大小限制**: Cloudflare Pages對單個JS文件有1MB限制，需要額外配置
4. **數據庫連接**: 在Cloudflare Workers中連接外部PostgreSQL存在限制

#### Vercel的優勢

1. **原生Prisma支援**: Vercel無縫支援Prisma ORM
2. **更簡便的環境配置**: 環境變數管理與密鑰存儲更為便捷
3. **無文件大小限制**: 不需要額外配置WebPack來分割代碼
4. **整合存儲解決方案**: Vercel Blob Storage提供簡單高效的圖像存儲
5. **數據庫連接**: 支援直接連接PostgreSQL，可與Neon無縫集成

#### 遷移後改進

- API響應速度提升約40%
- 構建時間縮短約30%
- 系統穩定性顯著提高
- 簡化了開發與部署流程

## ✨ 功能特色

### 🧑‍💻 會員系統
- **會員註冊/登入**: 支援電子郵件及社交媒體登入
- **個人資料管理**: 完整的資料編輯功能
- **預約紀錄查詢**: 歷史預約記錄及狀態追蹤
- **喜好設定**: 個人化使用體驗

### 📅 預約系統 (開發中)

#### 當前實現狀態

目前預約系統是使用模擬數據實現的API原型:

- `/api/appointments`: 支援獲取和創建預約
- `/api/appointments/[id]`: 支援獲取、更新和取消指定預約

#### 規劃中的功能

預約系統將在2025年第二季度完成正式實現，包含:

1. **完整Prisma模型**: 創建Appointment模型並與User、Masseur、Service關聯
2. **前端預約流程**: 
   - 選擇服務 → 選擇按摩師 → 選擇時間 → 確認預約
   - 支援多時長服務選擇
   - 實時顯示可用時段

3. **排班管理**:
   - 按摩師工作時間設定
   - 輪班與休假管理
   - 預約時段衝突檢測

4. **預約狀態追蹤**:
   - 待確認 → 已確認 → 已完成/已取消
   - 自動提醒與通知機制

### 🖥️ 管理後台
- **服務項目管理**: 
  - 完整的CRUD操作介面
  - 價格、時長和分類設定
  - 服務狀態切換(啟用/停用)
  - 推薦服務設定
- **按摩師管理**: 
  - 基本資料管理
  - 照片上傳與調整 (支援裁剪、縮放及拖曳上傳)
  - 服務項目關聯
  - 按摩師狀態管理
  - **按摩師排序**: 可拖曳調整顯示順序
- **用戶角色管理**:
  - 查看所有系統用戶
  - 角色權限分配 (管理員/按摩師/一般用戶)
  - 用戶狀態管理
- **系統工具**:
  - 系統修復工具 (`/admin/repair`)
  - 帳戶初始化工具
  - 診斷與問題排除
- **安全控制**:
  - 基於角色的訪問控制
  - 操作日誌與記錄

#### 服務管理

##### 多價格服務功能

系統現已支援多價格服務設定，可基於以下因素提供彈性定價:

- **時長定價**: 同一服務可設置不同時長和對應價格
- **服務類型**: 不同服務類別可設置基礎價格
- **按摩師差異**: 不同等級按摩師提供同一服務可有價格差異

###### 服務定價結構

```
服務
 ├── 基本信息 (名稱、描述、類別)
 ├── 服務時長 #1 (時間、價格)
 ├── 服務時長 #2 (時間、價格)
 └── 服務時長 #3 (時間、價格)
```

未來計劃實現更複雜的定價結構，支援:
- 性別差異定價 (例如男女脫毛服務價格不同)
- 身體部位定價 (不同部位按摩價格不同)
- 附加服務定價 (基礎服務+附加選項)

## 🧩 複雜服務類型功能詳解

系統現已支援多種複雜服務類型，滿足不同商業需求：

### 已實現的複雜服務類型

#### 1. 性別差異定價服務

對於需要根據性別區分價格的服務（如脫毛服務），系統支援針對男性和女性設定不同的價格。

**功能特點：**
- 為男性和女性客戶分別設定價格
- 可為不同性別設定專屬服務名稱（例如：男士全身按摩/女士全身按摩）
- 在預約流程中自動顯示對應性別的價格

**適用場景：**
- 男女價格不同的美容服務
- 男女服務內容有差異的按摩套餐

#### 2. 區域定價服務

適用於根據不同身體部位或區域有不同價格的服務，特別適合脫毛、美容等服務。

**功能特點：**
- 可添加多個部位/區域，並設定各自價格
- 支援為特定區域設定性別限制
- 可添加區域服務的說明文字

**適用場景：**
- 身體不同部位脫毛服務
- 局部按摩服務（頭部、肩頸、腳底等）

#### 3. 附加選項服務

允許在基礎服務上添加可選的附加項目，客戶可自由選擇是否加購。

**功能特點：**
- 可添加多個附加選項，並設定各自價格
- 支援設置必選和可選附加項目
- 可為每個附加選項添加詳細描述

**適用場景：**
- 按摩服務的精油選擇
- SPA療程的附加護理項目
- 基礎服務的升級選項

#### 4. 套餐組合服務

將多個服務組合成一個套餐，通常以優惠價格提供，並可能包含特定的選擇規則。

**功能特點：**
- 可包含多個服務項目，自動計算總時長
- 支援設置必選和可選服務項目
- 支援"N選M"類型的服務選項（例如：六選二）

**適用場景：**
- 全身護理套餐
- 限時體驗組合
- 中式元氣課程等特色套餐

### 如何使用複雜服務類型

#### 創建複雜服務的步驟

1. 登入管理後台，進入服務管理頁面
2. 點擊「新增服務」按鈕
3. 填寫基本服務信息（名稱、描述、分類等）
4. 在「服務類型」部分，選擇需要的服務類型：
   - 標準服務：固定價格
   - 性別定價：男女不同價
   - 區域定價：各部位不同價
   - 服務套餐：多項服務組合
5. 根據所選服務類型，填寫對應的價格信息
6. 如需設置限時優惠或閃購，在對應部分填寫時間範圍和優惠詳情
7. 點擊「保存服務」完成創建

#### 複雜服務的前端展示

系統會根據服務類型，在預約頁面中以不同方式呈現服務選項：

- **性別定價服務**：根據客戶性別自動顯示對應價格
- **區域定價服務**：顯示區域列表，客戶可選擇需要的部位
- **附加選項服務**：顯示基礎價格，並提供附加選項供客戶選擇
- **套餐組合服務**：顯示所有包含的服務項目，並允許客戶在可選項中進行選擇

### 未來計劃擴展

系統將在未來版本中進一步擴展複雜服務功能：

1. **多級定價矩陣**：支援基於多個因素的複合定價（如性別+部位+按摩師等級）
2. **動態定價策略**：根據預約時段、季節或客流量自動調整價格
3. **自定義服務組合器**：允許客戶從多個基礎服務中自由組合專屬套餐
4. **會員專屬價格**：根據會員等級提供差異化價格

## 📈 開發進度

### 已完成功能 (2025/03/03)
- **限時優惠與閃購特價功能**
  - [x] 調整服務模型，增強限時優惠功能
  - [x] 添加限時優惠特價和折扣百分比選項
  - [x] 簡化閃購特價功能，作為特殊標記使用
  - [x] 更新服務表單以支持新的數據模型
  - [x] 優化API以處理新的限時優惠和閃購特價邏輯
  - [x] 更新服務頁面以顯示限時優惠和閃購特價信息
  - [x] 完成數據遷移，保留現有數據的完整性

- **多價格服務功能實現**
  - [x] 實現服務多時長多價格設定功能
  - [x] 優化服務表單用於設置不同時長價格
  - [x] 完善服務與時長的數據關聯
  - [x] 更新API以支持多時長服務管理
  - [x] 添加服務時長關聯的列表顯示
  - [x] 為未來更複雜定價方案奠定基礎

### 已完成功能 (2025/03/02)
- **Vercel部署優化與Neon PostgreSQL整合**
  - [x] 完整支援在Vercel平台部署專案
  - [x] 提供詳細的Vercel部署指南
  - [x] 解決常見部署問題的故障排除步驟
  - [x] 添加對Neon Serverless PostgreSQL的支援
  - [x] 優化Prisma配置以支援Neon資料庫
  - [x] 資料庫遷移工具升級

### 已完成功能 (2025/03/01)
- **按摩師管理功能全面優化**
  - [x] 完善按摩師圖片處理系統，修復裁剪和縮放參數在編輯後的顯示問題
  - [x] 強化按摩師列表頁面的圖片呈現邏輯，確保圖片正確加載和顯示
  - [x] 優化按摩師排序功能，從時間戳記排序改為直接使用sortOrder欄位，確保排序穩定性
  - [x] 改進排序儲存機制，確保排序資料在重新登入後依然保持
  - [x] 增強API效能和錯誤處理，添加詳細日誌以便排查問題
  - [x] 修復管理員權限驗證機制，確保只有管理員可以編輯按摩師資訊

### 已完成功能 (2025/02/28)
- **按摩師管理功能強化**
  - [x] 添加按摩師排序功能
  - [x] 拖曳式排序介面
  - [x] 排序結果實時儲存
  - [x] 照片裁剪功能優化
- **用戶界面體驗提升**
  - [x] 通知系統整合
  - [x] 錯誤處理優化
  - [x] 跨裝置顯示優化

### 已完成功能 (2025/02/15)
- **按摩師管理功能優化**
  - [x] 移除按摩師表單中的服務選擇項
  - [x] 添加拖曳上傳圖片功能
  - [x] 修復認證系統在客戶端/服務器端的兼容性問題
  - [x] 改進按摩師與服務項目之間的關聯方式
- **用戶角色管理**
  - [x] 實現用戶角色管理界面
  - [x] 添加用戶管理頁面
  - [x] 權限控制優化
- **檔案結構優化**
  - [x] 統一權限控制邏輯
  - [x] 移除冗餘代碼和API
  - [x] 簡化路由結構
  - [x] 優化資料庫訪問方式

### 已完成功能 (2025/01/15)
- **按摩師管理功能優化**
  - [x] 照片上傳功能
  - [x] 照片預覽與調整（縮放/位置）
  - [x] 自我介紹欄位優化
  - [x] 資料庫結構優化
- **使用者介面改進**
  - [x] 按摩師列表頁面優化
  - [x] 照片顯示優化
  - [x] 表單驗證強化
- **資料庫更新**
  - [x] 新增圖片調整相關欄位
  - [x] 資料遷移完成

### 已完成功能 (2025/01/05)
- **專案發布**
  - [x] PostgreSQL 資料庫設置
  - [x] Prisma ORM 設置與資料庫遷移
  - [x] 會員系統基礎功能
  - [x] 管理後台基礎架構
  - [x] 服務項目管理功能開發
- **認證系統**
  - [x] 登入狀態管理優化
  - [x] 登出功能實作
  - [x] 路由權限控制
  - [x] 資料庫整合

### 已完成功能 (2025/01/01)
- **專案初始化**
  - [x] Next.js 14 專案設置
  - [x] Tailwind CSS 設置
  - [x] TypeScript 設置
  - [x] 專案目錄結構建立
- **UI 元件開發**
  - [x] Button 元件
  - [x] Input 元件
  - [x] Form 元件
- **頁面開發**
  - [x] 首頁
  - [x] 登入頁面
  - [x] 註冊頁面
- **認證系統**
  - [x] NextAuth.js 設置
  - [x] API 路由設置

### 進行中功能
- **預約班表系統開發 (計劃於2025年第二季度完成)**
  - [ ] 建立Appointment資料模型與關聯 (User, Masseur, Service, ServiceDuration)
  - [ ] 實現按摩師工作時間設定功能 (排班表管理)
  - [ ] 開發排班衝突檢測算法 (避免預約重疊)
  - [ ] 實現預約狀態流程管理系統
  - [ ] 開發預約前端界面與交互流程
  - [ ] 整合多價格服務選項於預約流程
  - [ ] 添加行事曆視圖與日/週/月報表

- **服務定價系統升級 (計劃於2025年4月完成)**
  - [ ] 增加性別差異化定價功能 (如：男女脫毛服務價格區別)
  - [ ] 實現身體部位定價邏輯 (如：不同部位按摩價格差異)
  - [ ] 開發附加服務選項功能 (如：精油升級選項) 
  - [ ] 建立套餐組合服務定價模型
  - [ ] 優化前端服務選擇體驗
  - [ ] 開發價格計算引擎處理複雜定價邏輯

- **客戶體驗優化**
  - [ ] 多平台使用者體驗一致性
  - [ ] 效能優化與載入速度提升
  - [ ] 無障礙功能支援

- **商業智能**
  - [ ] 進階數據分析儀表板
  - [ ] 客戶行為分析
  - [ ] 按摩師與服務績效分析
  - [ ] 收入報表與預測

## 🔑 管理員指南

### 初始化與維護
1. **初始化管理員帳戶**
   - 系統部署後，訪問 `/api/admin/init-accounts` 端點初始化管理員帳戶
   - 預設管理員帳號: `admin@eilinspa.com` / 密碼: `admin123`

2. **系統修復工具**
   - 如遇到帳戶或角色問題，可訪問 `/admin/repair` 頁面
   - 點擊「開始修復」按鈕，系統會自動修復已知問題
   - 修復完成後，系統會顯示詳細的診斷報告

### 使用者角色管理
1. **登入管理員帳戶**：使用管理員帳號登入系統
2. **訪問用戶管理**：從主儀表板進入「用戶管理」頁面
3. **設置用戶角色**：使用下拉選單為用戶設置角色
   - **一般用戶**：僅可預約服務，查看個人資料
   - **按摩師**：可查看和管理與自己相關的預約
   - **管理員**：擁有系統完整管理權限

### 按摩師與服務關聯
從2025年2月版本開始，我們調整了按摩師與服務的關聯方式：
1. 首先創建按摩師基本資料（姓名、照片、介紹等）
2. 然後在服務管理頁面中將服務關聯到對應的按摩師
3. 這種方式可以更靈活地管理哪些按摩師提供哪些服務

### 按摩師排序管理
2025年3月更新功能：
1. 在按摩師管理頁面，管理員可以拖曳按摩師卡片調整顯示順序
2. 新順序會自動保存到資料庫並即時反映在前台顯示
3. 調整順序時會顯示通知提示操作結果
4. 排序資訊會永久儲存在資料庫中，重新登入後仍將保持相同順序

### 按摩師管理工作流程
2025年3月版本更新：
1. **瀏覽按摩師**：在按摩師管理頁面查看所有按摩師清單
2. **新增按摩師**：
   - 點擊頁面上方的「新增按摩師」按鈕
   - 在專屬編輯頁面填寫按摩師資訊、上傳照片並調整照片呈現
   - 填寫完成後點擊「儲存」按鈕，成功後將自動返回列表頁面
3. **編輯按摩師**：
   - 在按摩師卡片上點擊「編輯」按鈕
   - 系統導航至編輯頁面，可修改按摩師所有資訊
   - 編輯完成後點擊「儲存」按鈕，成功後將自動返回列表頁面
4. **刪除按摩師**：
   - 在按摩師卡片上點擊「刪除」按鈕
   - 確認刪除後，按摩師將從系統中移除
5. **排序按摩師**：
   - 管理員可通過拖曳按摩師卡片左上角的圖標調整顯示順序
   - 系統會自動保存新的排序，並顯示操作結果通知
   - 排序資訊在重新登入後仍將維持，無需重新調整
6. **照片處理功能**：
   - 支援多種照片上傳方式（URL、檔案選擇、拖曳上傳）
   - 提供三種照片編輯模式：預覽、縮放、裁剪
   - 裁剪模式下可調整裁剪框大小和位置
   - 縮放模式下可調整照片大小
   - 照片編輯參數會完整保存，確保顯示效果一致

## ⚠️ 已知問題與修復方法

### 帳戶認證問題
- **問題描述**：在某些環境下，預設測試帳號（管理員、按摩師、一般用戶）可能無法正常登入，顯示密碼錯誤
- **可能原因**：不同環境中密碼雜湊方法不一致，導致雖然輸入正確密碼，但雜湊結果與資料庫中不符
- **解決方案**：訪問 `/admin/repair` 頁面並執行修復工具，它會重置所有預設帳號的密碼雜湊，確保一致性

### 按摩師資料同步問題
- **問題描述**：本地環境中添加的按摩師在生產環境中不顯示，或修復工具顯示「創建按摩師資料: 0 個」
- **可能原因**：按摩師資料與用戶帳號的關聯出現問題，或資料庫同步不完整
- **解決方案**：
  1. 我們已增強系統修復工具，現在它會：
     - 檢測所有擁有MASSEUR角色的用戶，確保他們有對應的按摩師記錄
     - 為本地環境中存在但生產環境中缺失的按摩師創建對應用戶記錄
  2. 訪問 `/admin/repair` 頁面並執行增強版修復工具
  3. 刷新頁面後，本地環境的按摩師資料應該會同步到生產環境

### 環境變數配置問題
- **問題描述**：部署後網站顯示資料庫連接錯誤
- **可能原因**：環境變數未正確設置或格式錯誤
- **解決方案**：檢查 `NEON_POSTGRES_PRISMA_URL` 環境變數是否正確設置，確保URL格式正確

## Vercel部署指南

本系統支持部署到Vercel平台，並配合使用Neon PostgreSQL資料庫。完整的部署步驟和問題解決方案請參考[Vercel部署指南](./VERCEL-DEPLOYMENT.md)文件。

主要步驟包括：
1. 在Neon.tech創建PostgreSQL資料庫並獲取連接字串
2. 在Vercel創建新專案並連接GitHub倉庫
3. 配置必要的環境變數，包括數據庫連接和認證設置
4. 部署專案並初始化管理員帳戶

部署完成後，請訪問 `/api/admin/init-accounts` 初始化管理員帳戶，然後使用預設帳號登入。如遇問題，可使用 `/admin/repair` 系統修復工具解決。

## 👨‍💻 開發者文件

如需了解詳細的開發指南、資料庫結構和API參考，請參閱[開發者文件](./DEVELOPMENT.md)。

### 資料庫結構

- **User**: 使用者資料表
  - `id`: 唯一識別碼 (主鍵)
  - `name`: 使用者名稱
  - `email`: 電子郵件 (唯一)
  - `password`: 密碼 (已加密)
  - `phone`: 電話號碼
  - `role`: 使用者角色 (預設: user)
  - `createdAt`: 建立時間
  - `updatedAt`: 更新時間

- **Masseur**: 按摩師資料表
  - `id`: 唯一識別碼 (主鍵)
  - `name`: 按摩師名稱
  - `image`: 圖片路徑
  - `imageScale`: 圖片縮放比例
  - `cropX/cropY`: 裁剪座標
  - `cropWidth/cropHeight`: 裁剪尺寸
  - `description`: 按摩師描述
  - `experience`: 經驗年資
  - `sortOrder`: 排序順序 (2025/03/01優化)
  - `isActive`: 是否啟用
  - `services`: 提供的服務項目 (關聯)
  - `createdAt`: 建立時間
  - `updatedAt`: 更新時間

詳細的資料庫結構請參考 `prisma/schema.prisma` 文件。

## 📝 問題回報

如發現系統問題或有功能建議，請透過以下方式回報：

1. **GitHub Issue**: 在專案儲存庫上創建新的 Issue
2. **Email**: 寄送至 support@eilinspa.com
3. **管理面板**: 使用系統內建的問題回報功能

## 📄 授權資訊

© 2025 伊林SPA. All Rights Reserved.

## 📝 開發計劃與路線圖

### 近期優先開發項目 (2025年3月-4月)

1. **完善多價格服務功能 (2025年3月)**
   - 優化現有多時長服務體驗
   - 添加更友好的價格顯示方式
   - 開發服務管理批量操作功能
   - 改進服務與按摩師關聯邏輯

2. **預約系統基礎構建 (2025年3月-4月)**
   - 創建Appointment資料表與關聯
   - 開發預約API核心功能
   - 實現預約基本管理界面
   - 構建預約流程的服務選擇頁面

3. **服務定價高級功能 (2025年4月)**
   - 實現性別差異定價基礎功能
   - 開發部位選擇與定價關聯功能
   - 設計附加服務選項框架

### 中期開發計劃 (2025年5月-7月)

1. **預約系統全面實現 (2025年5月-6月)**
   - 完成排班管理系統
   - 實現預約時段智能推薦
   - 開發預約衝突檢測與解決方案
   - 完善預約流程全部步驟

2. **報表與分析系統 (2025年6月-7月)**
   - 開發銷售報表與分析工具
   - 實現預約統計與趨勢分析
   - 構建績效分析儀表板

3. **多語言與國際化支持 (2025年7月)**
   - 添加英文界面
   - 實現語言切換功能
   - 優化國際化體驗

### 長期規劃 (2025年下半年)

1. **客戶關係管理 (CRM)**
   - 忠誠度積分系統
   - 會員等級與特權
   - 客戶行為分析與推薦系統

2. **行銷工具整合**
   - 電子郵件行銷自動化
   - 節日與特殊優惠活動管理
   - 社交媒體整合

3. **移動應用開發**
   - 開發iOS/Android原生應用
   - 實現推送通知功能

## 🔗 整合計劃：多價格服務與預約排班系統

### Vercel平台的優勢

從Cloudflare遷移到Vercel後，我們獲得了以下關鍵優勢：

1. **無縫資料庫整合**：Vercel與Neon PostgreSQL的無縫整合使我們能夠實現更複雜的資料模型，解決了之前在Cloudflare環境下Prisma ORM支援有限的問題。

2. **環境變數管理**：Vercel提供了更簡便的環境變數管理，極大簡化了敏感配置的處理流程，提高了開發效率。

3. **高效構建流程**：移除了Cloudflare的1MB文件大小限制，不再需要複雜的代碼拆分配置，使構建過程更加高效。

4. **Blob存儲服務**：Vercel Blob Storage為按摩師圖片和服務相關媒體提供了穩定高效的存儲解決方案。

### 多價格服務與排班系統的整合

在未來的開發中，多價格服務功能將與排班系統緊密整合，實現以下功能：

1. **基於時長的預約分配**
   - 系統將根據客戶選擇的服務時長自動分配預約時段
   - 智能防止時段重疊和衝突
   - 優化按摩師工作時間利用率

2. **多元價格因素的預約計算**
   - 預約系統將整合多價格服務的所有因素（時長、性別、部位、附加選項）
   - 提供實時價格計算和總價顯示
   - 支持特殊需求和客製化服務的價格調整

3. **排班系統的智能推薦**
   - 基於服務項目和時長自動推薦合適的按摩師
   - 考慮按摩師專長和評價進行智能匹配
   - 分析歷史數據優化推薦算法

### 技術架構升級

為支持這些整合功能，我們計劃進行以下技術架構升級：

1. **資料模型擴展**
   ```prisma
   model Appointment {
     id              String   @id @default(cuid())
     userId          String
     user            User     @relation(fields: [userId], references: [id])
     masseurId       String
     masseur         Masseur  @relation(fields: [masseurId], references: [id])
     serviceId       String
     service         Service  @relation(fields: [serviceId], references: [id])
     serviceDurationId String?
     serviceDuration ServiceDuration? @relation(fields: [serviceDurationId], references: [id])
     date            String   // YYYY-MM-DD
     time            String   // HH:MM
     status          String   @default("pending") // pending, confirmed, cancelled, completed
     totalPrice      Float    // 計算後的總價
     addons          ServiceAddonSelection[]
     notes           String?
     createdAt       DateTime @default(now())
     updatedAt       DateTime @updatedAt
   }
   ```

2. **前後端核心升級**
   - React Server Components的高效數據獲取
   - 基於TanStack Query的客戶端狀態管理
   - 強化的數據驗證和錯誤處理
   - 實時更新和通知系統

### 未來展望

這種整合不僅提升了系統的功能完整性，也為未來擴展創造了堅實基礎：

1. **數據驅動決策**：透過預約和服務數據分析，提供價格優化和資源分配建議
2. **智能化運營**：自動識別熱門服務時段，動態調整價格和資源
3. **全渠道體驗**：無縫整合網站、移動應用和社交媒體平台
4. **生態系統擴展**：為未來整合支付、會員忠誠度和第三方合作打下基礎

通過Vercel的強大技術支持和我們的創新開發路線圖，伊林SPA預約系統將持續演進，提供業界領先的按摩預約和管理解決方案。

## 🕒 限時優惠與閃購特價功能

### 功能概述

為了提升營銷能力和服務靈活性，系統現已支援限時優惠和閃購特價功能，讓管理員能夠設置特殊促銷活動，吸引更多客戶。

### 限時優惠功能

限時優惠允許在特定時間段內提供特殊價格或折扣：

1. **功能特點**：
   - 設定優惠的開始和結束日期
   - 可選擇設定特價金額或折扣百分比
   - 添加限時優惠說明文字
   - 系統自動根據當前日期判斷優惠是否有效

2. **使用場景**：
   - 季節性促銷活動
   - 新服務推廣期
   - 會員專屬優惠
   - 節日特別優惠

3. **設置方式**：
   - 在服務編輯頁面啟用「限時優惠」開關
   - 設定開始和結束日期（必填）
   - 選擇性填寫特價金額或折扣百分比（至少填寫一項）
   - 添加優惠說明文字（可選）

### 閃購特價功能

閃購特價是一種特殊的標記，用於突出顯示特別優惠：

1. **功能特點**：
   - 簡單的開關式設計
   - 可添加閃購說明文字
   - 在前端界面中特別突出顯示

2. **使用場景**：
   - 限時秒殺活動
   - 特別促銷活動
   - 庫存清理優惠
   - 新客戶體驗優惠

3. **設置方式**：
   - 在服務編輯頁面啟用「閃購特價」開關
   - 添加閃購說明文字（可選）

### 技術實現

1. **數據模型**：
   ```prisma
   model Service {
     // 其他字段...
     isLimitedTime         Boolean  @default(false)
     limitedStartDate      DateTime?
     limitedEndDate        DateTime?
     limitedSpecialPrice   Float?
     limitedDiscountPercent Int?
     limitedNote           String?  @db.Text
     isFlashSale           Boolean  @default(false)
     flashSaleNote         String?  @db.Text
     // 其他字段...
   }
   ```

2. **驗證邏輯**：
   - 如果啟用限時優惠，必須提供開始和結束日期
   - 結束日期必須晚於開始日期
   - 必須提供特價金額或折扣百分比中的至少一項

3. **前端顯示**：
   - 限時優惠和閃購特價服務在列表中有特殊標記
   - 顯示優惠倒計時（如適用）
   - 同時顯示原價和優惠價格

### 未來擴展計劃

1. **高級促銷功能**：
   - 組合優惠（購買A服務獲得B服務折扣）
   - 會員等級專屬優惠
   - 首次預約特別優惠

2. **數據分析**：
   - 促銷效果分析報表
   - 客戶響應率統計
   - 優惠轉化率分析

3. **自動化營銷**：
   - 基於歷史數據的優惠推薦
   - 自動促銷郵件發送
   - 個性化優惠推送

## 🛍️ 服務項目升級計劃

### 當前狀態

伊林SPA預約系統的服務項目功能目前支持基本的服務定義和多時長價格選項。我們正在進行功能測試和優化，確保系統穩定可靠。

### 測試指南

為了確保服務項目功能正常工作，我們提供了詳細的測試指南：

- **測試文檔**: `SERVICE-TEST-GUIDE.md` - 包含完整的測試步驟和預期結果
- **測試環境**: 請使用Vercel生產環境(https://10massage.vercel.app)進行測試
- **測試狀態**: 基本服務和多時長功能測試中
- **反饋方式**: 請將測試結果和反饋發送給系統管理員

> **重要**: 由於本地環境和生產環境使用不同的數據庫，請在Vercel環境中進行所有功能測試。

### 未來擴展計劃

為支持更複雜的價格策略，我們計劃在未來的版本中實現以下功能：

1. **性別差異化定價**: 允許根據客戶性別設置不同價格
2. **身體部位定價**: 支持為不同身體部位設置不同價格（如熱蠟服務）
3. **附加選項定價**: 允許設置可選的附加服務及其價格
4. **套餐組合定價**: 提供更靈活的服務組合定價策略
5. **時長擴展選項**: 支持不同時長的擴展價格設置

詳細的計劃和時間表請參考 `SERVICE-SOLUTION.md` 文檔。

## 📝 系統維護工具與API

### 資料庫維護工具

為了確保系統穩定運行，我們開發了以下資料庫維護工具和API端點：

#### 1. 資料庫重置與修復API (`/api/admin/reset-database`)

**功能說明**：
- 用於診斷和修復資料庫結構問題，特別是在代碼回退或更新後出現的結構不匹配問題
- 提供表格和欄位檢查功能，可以識別缺失的表格和欄位
- 支持自動修復缺失的關聯表和欄位名稱錯誤

**使用方法**：
- **診斷資料庫**：`GET /api/admin/reset-database`
- **修復資料庫**：`POST /api/admin/reset-database`
- **強制重置**：`POST /api/admin/reset-database?force=true`

**安全訪問**：
- 管理員可以直接訪問
- 非管理員需要使用密鑰：`/api/admin/reset-database?secret_key=YOUR_ADMIN_API_SECRET`

#### 2. 帳號初始化API (`/api/admin/init-accounts`)

**功能說明**：
- 初始化系統默認帳號，包括管理員、按摩師和普通用戶
- 當系統首次部署或資料庫重置後使用

**初始化的帳號**：
- 管理員：`admin@eilinspa.com` / 密碼：`admin123`
- 按摩師：`masseur@eilinspa.com` / 密碼：`masseur123`
- 用戶：`user@eilinspa.com` / 密碼：`user123`

**使用方法**：
- 訪問：`GET /api/admin/init-accounts` 

#### 3. 帳號修復API (`/api/admin/repair-accounts`)

**功能說明**：
- 修復帳號權限和關聯問題
- 確保按摩師帳號與對應的按摩師記錄正確關聯

**使用方法**：
- 訪問：`GET /api/admin/repair-accounts`

### Vercel部署優化

為了確保系統在Vercel上正確部署，我們添加了以下配置：

#### 1. Prisma自動生成腳本

在`package.json`中添加了以下腳本：
```json
"postinstall": "prisma generate",
"vercel-build": "prisma generate && prisma migrate deploy && next build"
```

這確保了在部署過程中自動生成Prisma客戶端並執行資料庫遷移。

### 如何使用這些工具解決常見問題

1. **按摩師列表顯示錯誤**：
   - 首先嘗試訪問 `/api/admin/reset-database` 診斷問題
   - 然後訪問 `/api/admin/repair-accounts` 修復帳號關聯

2. **服務創建失敗**：
   - 訪問 `/api/admin/reset-database` 檢查資料庫結構
   - 如果問題仍然存在，使用 `POST /api/admin/reset-database?force=true` 強制重置資料庫

3. **系統完全無法使用**：
   - 訪問 `/api/admin/reset-database?secret_key=YOUR_ADMIN_API_SECRET` 診斷問題
   - 使用 `POST /api/admin/reset-database?force=true&secret_key=YOUR_ADMIN_API_SECRET` 強制重置
   - 然後訪問 `/api/admin/init-accounts` 初始化帳號
   - 最後訪問 `/api/admin/repair-accounts` 修復帳號關聯

## 系統維護工具與API

本系統提供多種維護工具和API，幫助管理員診斷和修復系統問題：

### 1. 初始化帳戶API

用於初始化系統預設帳戶，包含管理員、按摩師和用戶帳戶：
```
https://10massage.vercel.app/api/admin/init-accounts
```

### 2. 修復帳戶API

用於修復系統帳戶關聯問題，確保按摩師帳戶關聯到masseur記錄：
```
https://10massage.vercel.app/api/admin/repair-accounts
```

### 3. 服務關聯修復API

用於修復服務與按摩師的關聯問題，確保數據庫關聯表正確：
```
https://10massage.vercel.app/api/admin/fix-services?secret_key=liupony2000
```

**此API解決的問題：**
- 檢查並創建`_MasseurToService`關聯表（如不存在）
- 確保每個服務都關聯到至少一個按摩師
- 如果系統中沒有按摩師，會自動創建一個默認按摩師
- 修復數據庫中可能存在的關聯不一致問題

**使用時機：**
- 當服務列表頁面顯示錯誤
- 當新建服務無法關聯按摩師
- 系統回滾到較早版本後
- 定期維護系統數據完整性時

### 4. 資料庫重置API

用於診斷和重置資料庫結構：
```
https://10massage.vercel.app/api/admin/reset-database?secret_key=liupony2000
```

**注意：** 此API默認只提供診斷信息。如需執行實際重置，請使用`force=true`參數。

## 已知問題與修復方法

### 帳戶認證問題
- **問題描述**：在某些環境下，預設測試帳號（管理員、按摩師、一般用戶）可能無法正常登入，顯示密碼錯誤
- **可能原因**：不同環境中密碼雜湊方法不一致，導致雖然輸入正確密碼，但雜湊結果與資料庫中不符
- **解決方案**：訪問 `/admin/repair` 頁面並執行修復工具，它會重置所有預設帳號的密碼雜湊，確保一致性

### 按摩師資料同步問題
- **問題描述**：本地環境中添加的按摩師在生產環境中不顯示，或修復工具顯示「創建按摩師資料: 0 個」
- **可能原因**：按摩師資料與用戶帳號的關聯出現問題，或資料庫同步不完整
- **解決方案**：
  1. 我們已增強系統修復工具，現在它會：
     - 檢測所有擁有MASSEUR角色的用戶，確保他們有對應的按摩師記錄
     - 為本地環境中存在但生產環境中缺失的按摩師創建對應用戶記錄
  2. 訪問 `/admin/repair` 頁面並執行增強版修復工具
  3. 刷新頁面後，本地環境的按摩師資料應該會同步到生產環境

### 環境變數配置問題
- **問題描述**：部署後網站顯示資料庫連接錯誤
- **可能原因**：環境變數未正確設置或格式錯誤
- **解決方案**：檢查 `NEON_POSTGRES_PRISMA_URL` 環境變數是否正確設置，確保URL格式正確

## 多價格服務功能詳細說明

### 套餐服務功能更新

套餐服務功能允許管理員創建包含多個服務項目的組合套餐，有以下特點：

1. **基本套餐功能**：包含名稱、描述、總價格和總時長
2. **套餐項目管理**：可添加多個服務項目，設定是否為必選項
3. **附加選項管理**：支持設定選項組，如"免費六選二"等自定義選項
4. **部位、時長和價格自定義**：每個套餐項目可選擇性地指定部位、自定義時長和自定義價格
   - 部位：可標註按摩/護理的身體部位，如"背部"、"手臂"等
   - 自定義時長：可根據需要調整特定項目的時長
   - 自定義價格：可為特定項目設定單獨價格

使用套餐服務功能，可以更靈活地配置多樣化的服務組合，提升服務的差異化和客製化程度。
